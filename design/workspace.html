<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeSentinel - 工作台</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            background-color: #000;
            color: #e2e8f0;
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        .scrollbar-thin::-webkit-scrollbar { width: 4px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }

        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .code-line:hover { background-color: rgba(255, 255, 255, 0.03); }

        .diff-add { background-color: rgba(34, 197, 94, 0.1); border-left: 3px solid #22c55e; }
        .diff-remove { background-color: rgba(239, 68, 68, 0.1); border-left: 3px solid #ef4444; }
        .diff-context { background-color: transparent; border-left: 3px solid transparent; }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, Fragment } = React;

        // --- Icons ---
        const Icons = {
            Shield: <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10" />,
            GitPullRequest: <><circle cx="18" cy="18" r="3" /><circle cx="6" cy="6" r="3" /><path d="M13 6h3a2 2 0 0 1 2 2v7" /><line x1="6" x2="6" y1="9" y2="21" /></>,
            GitMerge: <><circle cx="18" cy="18" r="3" /><circle cx="6" cy="6" r="3" /><path d="M6 21V9a9 9 0 0 0 9 9" /></>,
            Search: <><circle cx="11" cy="11" r="8" /><path d="m21 21-4.3-4.3" /></>,
            Code: <><polyline points="16 18 22 12 16 6" /><polyline points="8 6 2 12 8 18" /></>,
            Zap: <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />,
            CheckCircle2: <><circle cx="12" cy="12" r="10" /><path d="m9 12 2 2 4-4" /></>,
            Play: <polygon points="5 3 19 12 5 21 5 3" />,
            Loader2: <path d="M21 12a9 9 0 1 1-6.219-8.56" />,
            Check: <path d="M20 6 9 17l-5-5" />,
            X: <path d="M18 6 6 18M6 6l12 12" />,
            ChevronRight: <path d="m9 18 6-6-6-6" />,
            ChevronDown: <path d="m6 9 6 6 6-6" />,
            Terminal: <><polyline points="4 17 10 11 4 5" /><line x1="12" x2="20" y1="19" y2="19" /></>,
            FilePlus: <><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /><line x1="12" x2="12" y1="11" y2="17" /><line x1="9" x2="15" y1="14" y2="14" /></>,
            RotateCcw: <><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12" /><path d="M3 3v9h9" /></>,
            Sparkles: <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L12 3Z" />,
            FileText: <><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /><line x1="16" x2="8" y1="13" y2="13" /><line x1="16" x2="8" y1="17" y2="17" /><line x1="10" x2="8" y1="9" y2="9" /></>,
            Filter: <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3" />,
            Copy: <><rect width="14" height="14" x="8" y="8" rx="2" ry="2" /><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" /></>,
            Download: <><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" x2="12" y1="15" y2="3" /></>,
            Maximize2: <><polyline points="15 3 21 3 21 9" /><polyline points="9 21 3 21 3 15" /><line x1="21" x2="14" y1="3" y2="10" /><line x1="3" x2="10" y1="21" y2="14" /></>,
            SplitSquareHorizontal: <><path d="M8 19H5c-1 0-2-1-2-2V7c0-1 1-2 2-2h3" /><path d="M16 5h3c1 0 2 1 2 2v10c0 1-1 2-2 2h-3" /><line x1="12" x2="12" y1="4" y2="20" /></>,
            AlertTriangle: <><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" /><line x1="12" x2="12" y1="9" y2="13" /><line x1="12" x2="12.01" y1="17" y2="17" /></>,
            Clock: <><circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" /></>,
            TestTube: <><path d="M14.5 2v17.5c0 1.4-1.1 2.5-2.5 2.5h0c-1.4 0-2.5-1.1-2.5-2.5V2" /><path d="M8.5 2h7" /><path d="M14.5 16h-5" /></>,
            Bug: <><path d="m8 2 1.88 1.88" /><path d="M14.12 3.88 16 2" /><path d="M9 7.13v-1a3.003 3.003 0 1 1 6 0v1" /><path d="M12 20c-3.3 0-6-2.7-6-6v-3a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v3c0 3.3-2.7 6-6 6" /><path d="M12 20v-9" /><path d="M6.53 9C4.6 8.8 3 7.1 3 5" /><path d="M6 13H2" /><path d="M3 21c0-2.1 1.7-3.9 3.8-4" /><path d="M20.97 5c0 2.1-1.6 3.8-3.5 4" /><path d="M22 13h-4" /><path d="M17.2 17c2.1.1 3.8 1.9 3.8 4" /></>,
            FileCode: <><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /><path d="m10 13-2 2 2 2" /><path d="m14 17 2-2-2-2" /></>,
            Eye: <><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" /><circle cx="12" cy="12" r="3" /></>,
            Layers: <><polygon points="12 2 2 7 12 12 22 7 12 2" /><polyline points="2 17 12 22 22 17" /><polyline points="2 12 12 17 22 12" /></>
        };

        const Lucide = ({ name, className, size = 16 }) => {
            const icon = Icons[name];
            return icon ? (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icon}
                </svg>
            ) : null;
        };

        // --- Navbar ---
        const Navbar = ({ active }) => (
            <nav className="h-16 flex items-center justify-between px-8 border-b border-white/5 bg-[#0A0A0A]/80 backdrop-blur-md sticky top-0 z-50">
                <div className="flex items-center gap-8">
                    <a href="index.html" className="flex items-center gap-3 group">
                        <div className="w-9 h-9 rounded-xl bg-indigo-600 flex items-center justify-center shadow-lg shadow-indigo-500/20 group-hover:scale-105 transition-transform">
                            <Lucide name="Shield" className="text-white" size={20} />
                        </div>
                        <span className="font-bold text-xl tracking-tight text-white group-hover:text-white/90 transition-colors">
                            CodeSentinel <span className="text-indigo-400 text-xs ml-1 font-normal bg-indigo-500/10 px-1.5 py-0.5 rounded border border-indigo-500/20">Ent</span>
                        </span>
                    </a>
                    <div className="hidden md:flex items-center bg-white/5 rounded-lg p-1 border border-white/5">
                        {[
                            { id: 'overview', label: '仪表盘', href: 'overview.html' },
                            { id: 'workspace', label: '工作台', href: 'workspace.html' },
                            { id: 'pipeline', label: '流水线', href: 'pipeline.html' },
                            { id: 'configuration', label: '仓库配置', href: 'configuration.html' }
                        ].map((item) => (
                            <a key={item.id} href={item.href} className={`px-5 py-1.5 rounded-md text-sm font-medium transition-all ${active === item.id ? 'bg-white/10 text-white shadow-sm' : 'text-white/40 hover:text-white/80 hover:bg-white/5'}`}>
                                {item.label}
                            </a>
                        ))}
                    </div>
                </div>
                <div className="flex items-center gap-4">
                    <div className="flex items-center gap-3 pl-4">
                        <div className="flex flex-col items-end">
                            <span className="text-xs font-medium text-white">张三 (Dev)</span>
                            <span className="text-[10px] text-white/40">GitLab Pro</span>
                        </div>
                        <div className="w-8 h-8 rounded-full bg-gradient-to-tr from-indigo-500 to-purple-500 p-[1px]">
                            <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" alt="User" className="w-full h-full rounded-full bg-black" />
                        </div>
                    </div>
                </div>
            </nav>
        );

        // --- Mock Data & Constants ---
        const MOCK_BRANCHES = ['main', 'develop', 'feat/shipping-logic', 'feat/user-auth-v2', 'fix/inventory-bug'];
        const MOCK_DOCS = [
            { id: '1', name: 'PRD-2024-001_电商核心交易流程.pdf', size: '2.4 MB', status: 'parsed', uploadTime: '2024-01-15 10:00' },
            { id: '2', name: 'API_Spec_v2.0.yaml', size: '156 KB', status: 'parsed', uploadTime: '2024-01-16 14:20' },
            { id: '3', name: '用户等级运费规则说明.md', size: '45 KB', status: 'parsed', uploadTime: '2024-01-17 09:30' },
        ];

        const CODE_BEFORE = [
            { num: 1, content: 'public BigDecimal calculate(User user, Order order) {', type: 'context' },
            { num: 2, content: '    // 基础逻辑：Level 1 用户运费', type: 'context' },
            { num: 3, content: '    if (user.getLevel() == 1) {', type: 'context' },
            { num: 4, content: '        return new BigDecimal("10.00");', type: 'context' },
            { num: 5, content: '    }', type: 'context' },
            { num: 6, content: '', type: 'context' },
            { num: 7, content: '    // TODO: Level 2 逻辑待实现', type: 'remove' },
            { num: 8, content: '', type: 'context' },
            { num: 9, content: '    if (user.getLevel() >= 3) {', type: 'context' },
            { num: 10, content: '        return BigDecimal.ZERO;', type: 'context' },
            { num: 11, content: '    }', type: 'context' },
            { num: 12, content: '', type: 'context' },
            { num: 13, content: '    return new BigDecimal("15.00"); // 默认兜底运费', type: 'context' },
            { num: 14, content: '}', type: 'context' },
        ];

        const CODE_AFTER = [
            { num: 1, content: 'public BigDecimal calculate(User user, Order order) {', type: 'context' },
            { num: 2, content: '    // 基础逻辑：Level 1 用户运费', type: 'context' },
            { num: 3, content: '    if (user.getLevel() == 1) {', type: 'context' },
            { num: 4, content: '        return new BigDecimal("10.00");', type: 'context' },
            { num: 5, content: '    }', type: 'context' },
            { num: 6, content: '', type: 'context' },
            { num: 7, content: '    // AI 自动修复：Level 2 用户运费逻辑', type: 'add' },
            { num: 8, content: '    if (user.getLevel() == 2) {', type: 'add' },
            { num: 9, content: '        if (order.getAmount().compareTo(new BigDecimal("100")) > 0) {', type: 'add' },
            { num: 10, content: '            return new BigDecimal("7.50"); // 满100减50%', type: 'add' },
            { num: 11, content: '        }', type: 'add' },
            { num: 12, content: '        return new BigDecimal("15.00");', type: 'add' },
            { num: 13, content: '    }', type: 'add' },
            { num: 14, content: '', type: 'context' },
            { num: 15, content: '    if (user.getLevel() >= 3) {', type: 'context' },
            { num: 16, content: '        return BigDecimal.ZERO;', type: 'context' },
            { num: 17, content: '    }', type: 'context' },
            { num: 18, content: '', type: 'context' },
            { num: 19, content: '    return new BigDecimal("15.00"); // 默认兜底运费', type: 'context' },
            { num: 20, content: '}', type: 'context' },
        ];

        const TEST_CASES = [
            { id: 1, name: 'test_level1_shipping_fixed_fee', status: 'passed', duration: '0.12s', desc: '验证Level 1用户固定运费10元' },
            { id: 2, name: 'test_level2_shipping_discount', status: 'passed', duration: '0.08s', desc: '验证Level 2用户满100减50%运费' },
            { id: 3, name: 'test_level2_below_threshold', status: 'passed', duration: '0.05s', desc: '验证Level 2用户未满100保持15元' },
            { id: 4, name: 'test_level3_free_shipping', status: 'passed', duration: '0.03s', desc: '验证Level 3+用户免运费' },
            { id: 5, name: 'test_default_shipping_fee', status: 'passed', duration: '0.04s', desc: '验证默认运费兜底逻辑' },
        ];

        // --- Components ---
        const PipelineSteps = ({ currentStage, expandedStep, onStepClick }) => {
            const steps = [
                { id: 'analyzing', label: '影响分析', icon: 'Search', desc: '分析代码变更影响范围', details: '扫描变更文件、分析调用链、识别影响模块' },
                { id: 'generating', label: '生成用例', icon: 'Code', desc: '基于PRD生成测试用例', details: '解析需求文档、提取验证规则、生成测试代码' },
                { id: 'executing', label: '执行测试', icon: 'Play', desc: '沙箱环境执行测试', details: 'Docker隔离执行、收集覆盖率、记录测试结果' },
                { id: 'healing', label: '自动修复', icon: 'Zap', desc: 'AI分析并修复问题', details: '根因分析(RCA)、生成修复补丁、验证修复效果' },
                { id: 'success', label: '验证通过', icon: 'CheckCircle2', desc: '所有检查已通过', details: '生成测试报告、更新质量评分、提交MR评审' },
            ];

            const getStepStatus = (stepId) => {
                const stages = ['idle', 'analyzing', 'generating', 'executing', 'failure', 'healing', 'success'];
                const currentIndex = stages.indexOf(currentStage === 'failure' ? 'executing' : currentStage);
                const stepIndex = stages.indexOf(stepId);

                if (currentStage === 'failure' && stepId === 'executing') return 'error';
                if (currentIndex > stepIndex) return 'completed';
                if (currentIndex === stepIndex) return 'active';
                return 'pending';
            };

            return (
                <div className="border-b border-white/5 bg-[#050505]">
                    <div className="flex items-center justify-between px-12 py-6">
                        {steps.map((step, idx) => {
                            const status = getStepStatus(step.id);
                            const isExpanded = expandedStep === step.id;
                            return (
                                <React.Fragment key={step.id}>
                                    <div
                                        className={`flex flex-col items-center gap-2 relative z-10 transition-all cursor-pointer ${status === 'pending' ? 'opacity-30' : 'opacity-100'}`}
                                        onClick={() => status !== 'pending' && onStepClick(isExpanded ? null : step.id)}
                                    >
                                        <div className={`w-12 h-12 rounded-full flex items-center justify-center border-2 transition-all duration-500 ${
                                            status === 'active' ? 'border-indigo-500 bg-indigo-500/20 text-indigo-400 shadow-[0_0_20px_rgba(99,102,241,0.5)] scale-110' :
                                            status === 'completed' ? 'border-emerald-500 bg-emerald-500 text-black' :
                                            status === 'error' ? 'border-rose-500 bg-rose-500 text-white' :
                                            'border-white/20 bg-black text-white/40'
                                        }`}>
                                            {status === 'active' ? <Lucide name="Loader2" size={20} className="animate-spin" /> :
                                                status === 'completed' ? <Lucide name="Check" size={20} className="stroke-[3]" /> :
                                                status === 'error' ? <Lucide name="X" size={20} className="stroke-[3]" /> :
                                                <Lucide name={step.icon} size={20} />}
                                        </div>
                                        <span className={`text-xs font-bold tracking-wide uppercase ${
                                            status === 'active' ? 'text-indigo-400' :
                                            status === 'completed' ? 'text-emerald-500' :
                                            status === 'error' ? 'text-rose-500' :
                                            'text-white/40'
                                        }`}>{step.label}</span>
                                        {isExpanded && <Lucide name="ChevronDown" size={14} className="text-indigo-400" />}
                                    </div>
                                    {idx < steps.length - 1 && (
                                        <div className="flex-1 h-[2px] bg-white/5 mx-6 relative overflow-hidden rounded-full">
                                            <div className={`absolute inset-0 bg-gradient-to-r from-indigo-500 to-indigo-400 transition-transform duration-700 ease-out ${
                                                getStepStatus(steps[idx + 1].id) !== 'pending' ? 'translate-x-0' : '-translate-x-full'
                                            }`} />
                                        </div>
                                    )}
                                </React.Fragment>
                            );
                        })}
                    </div>

                    {/* Expanded Step Details */}
                    {expandedStep && (
                        <div className="px-12 pb-6 slide-up">
                            <div className="bg-[#0A0A0A] border border-white/10 rounded-xl p-6">
                                {(() => {
                                    const step = steps.find(s => s.id === expandedStep);
                                    const status = getStepStatus(expandedStep);
                                    return (
                                        <div className="flex items-start gap-6">
                                            <div className={`p-4 rounded-xl ${
                                                status === 'completed' ? 'bg-emerald-500/10 text-emerald-400' :
                                                status === 'active' ? 'bg-indigo-500/10 text-indigo-400' :
                                                status === 'error' ? 'bg-rose-500/10 text-rose-400' :
                                                'bg-white/5 text-white/40'
                                            }`}>
                                                <Lucide name={step.icon} size={28} />
                                            </div>
                                            <div className="flex-1">
                                                <h4 className="text-lg font-bold text-white mb-2">{step.label}</h4>
                                                <p className="text-sm text-white/60 mb-4">{step.details}</p>
                                                {status === 'completed' && expandedStep === 'generating' && (
                                                    <div className="bg-black/40 rounded-lg p-4 border border-white/5">
                                                        <div className="text-xs text-white/40 mb-3 uppercase tracking-wider">生成的测试用例</div>
                                                        <div className="space-y-2">
                                                            {TEST_CASES.slice(0, 3).map(tc => (
                                                                <div key={tc.id} className="flex items-center gap-3 text-sm">
                                                                    <Lucide name="CheckCircle2" size={14} className="text-emerald-400" />
                                                                    <span className="font-mono text-white/80">{tc.name}</span>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}
                                                {status === 'active' && (
                                                    <div className="flex items-center gap-2 text-sm text-indigo-400">
                                                        <Lucide name="Loader2" size={14} className="animate-spin" />
                                                        <span>正在处理中...</span>
                                                    </div>
                                                )}
                                            </div>
                                            <div className="text-right text-xs text-white/30">
                                                {status === 'completed' && <span className="text-emerald-400">已完成</span>}
                                                {status === 'active' && <span className="text-indigo-400">进行中</span>}
                                                {status === 'error' && <span className="text-rose-400">失败</span>}
                                            </div>
                                        </div>
                                    );
                                })()}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- Diff View Component ---
        const DiffView = ({ before, after, viewMode }) => {
            if (viewMode === 'split') {
                return (
                    <div className="flex h-full">
                        {/* Before */}
                        <div className="flex-1 border-r border-white/5 overflow-auto">
                            <div className="sticky top-0 bg-[#0A0A0A] border-b border-white/5 px-4 py-2 text-xs font-bold text-rose-400 flex items-center gap-2">
                                <span className="w-2 h-2 rounded-full bg-rose-500"></span> 修改前
                            </div>
                            <div className="p-4 font-mono text-sm">
                                {before.map((line, i) => (
                                    <div key={i} className={`flex px-2 py-0.5 ${line.type === 'remove' ? 'diff-remove' : 'diff-context'}`}>
                                        <span className="w-8 inline-block text-white/20 select-none mr-4 text-right text-xs">{line.num}</span>
                                        <span className={`whitespace-pre ${line.type === 'remove' ? 'text-rose-300' : 'text-white/60'}`}>{line.content || ' '}</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                        {/* After */}
                        <div className="flex-1 overflow-auto">
                            <div className="sticky top-0 bg-[#0A0A0A] border-b border-white/5 px-4 py-2 text-xs font-bold text-emerald-400 flex items-center gap-2">
                                <span className="w-2 h-2 rounded-full bg-emerald-500"></span> 修改后
                            </div>
                            <div className="p-4 font-mono text-sm">
                                {after.map((line, i) => (
                                    <div key={i} className={`flex px-2 py-0.5 ${line.type === 'add' ? 'diff-add' : 'diff-context'}`}>
                                        <span className="w-8 inline-block text-white/20 select-none mr-4 text-right text-xs">{line.num}</span>
                                        <span className={`whitespace-pre ${line.type === 'add' ? 'text-emerald-300 font-medium' : 'text-white/60'}`}>{line.content || ' '}</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            }

            // Unified view
            return (
                <div className="overflow-auto h-full">
                    <div className="p-4 font-mono text-sm">
                        {after.map((line, i) => (
                            <div key={i} className={`flex px-2 py-0.5 rounded ${
                                line.type === 'add' ? 'diff-add' :
                                line.type === 'remove' ? 'diff-remove' :
                                'diff-context hover:bg-white/[0.02]'
                            }`}>
                                <span className="w-6 inline-block text-center text-white/20 select-none mr-2 text-xs">
                                    {line.type === 'add' ? '+' : line.type === 'remove' ? '-' : ' '}
                                </span>
                                <span className="w-8 inline-block text-white/20 select-none mr-4 text-right text-xs">{line.num}</span>
                                <span className={`whitespace-pre flex-1 ${
                                    line.type === 'add' ? 'text-emerald-300 font-medium' :
                                    line.type === 'remove' ? 'text-rose-300' :
                                    'text-white/60'
                                }`}>{line.content || ' '}</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- Test Results Panel ---
        const TestResultsPanel = ({ testCases, isVisible }) => {
            if (!isVisible) return null;

            const passed = testCases.filter(t => t.status === 'passed').length;
            const failed = testCases.filter(t => t.status === 'failed').length;

            return (
                <div className="border-t border-white/5 bg-[#0A0A0A] slide-up">
                    <div className="flex items-center justify-between px-6 py-3 border-b border-white/5">
                        <div className="flex items-center gap-4">
                            <h4 className="text-sm font-bold text-white flex items-center gap-2">
                                <Lucide name="TestTube" size={16} className="text-indigo-400" /> 测试结果
                            </h4>
                            <div className="flex items-center gap-3 text-xs">
                                <span className="flex items-center gap-1 text-emerald-400">
                                    <Lucide name="CheckCircle2" size={12} /> {passed} 通过
                                </span>
                                {failed > 0 && (
                                    <span className="flex items-center gap-1 text-rose-400">
                                        <Lucide name="X" size={12} /> {failed} 失败
                                    </span>
                                )}
                            </div>
                        </div>
                        <div className="text-xs text-white/40">
                            覆盖率: <span className="text-emerald-400 font-bold">92.5%</span>
                        </div>
                    </div>
                    <div className="max-h-48 overflow-y-auto scrollbar-thin">
                        <table className="w-full text-sm">
                            <tbody className="divide-y divide-white/5">
                                {testCases.map(tc => (
                                    <tr key={tc.id} className="hover:bg-white/[0.02]">
                                        <td className="px-6 py-3 w-8">
                                            {tc.status === 'passed' ? (
                                                <Lucide name="CheckCircle2" size={16} className="text-emerald-400" />
                                            ) : (
                                                <Lucide name="X" size={16} className="text-rose-400" />
                                            )}
                                        </td>
                                        <td className="py-3 font-mono text-white/80">{tc.name}</td>
                                        <td className="py-3 text-white/40 text-xs">{tc.desc}</td>
                                        <td className="px-6 py-3 text-right text-white/30 text-xs">{tc.duration}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // --- Main Workspace View ---
        const WorkspaceView = () => {
            const [stage, setStage] = useState('idle');
            const [logs, setLogs] = useState([]);
            const scrollRef = useRef(null);
            const [selectedBranch, setSelectedBranch] = useState(MOCK_BRANCHES[2]);
            const [selectedDoc, setSelectedDoc] = useState(MOCK_DOCS[0].id);
            const [expandedStep, setExpandedStep] = useState(null);
            const [viewMode, setViewMode] = useState('split'); // 'split' or 'unified'
            const [logFilter, setLogFilter] = useState('all');
            const [logSearch, setLogSearch] = useState('');
            const [showTestResults, setShowTestResults] = useState(false);

            const addLog = (type, message) => {
                setLogs(prev => [...prev, { id: Date.now() + Math.random(), type, message, timestamp: new Date().toLocaleTimeString('zh-CN') }]);
            };

            useEffect(() => { if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight; }, [logs]);

            const filteredLogs = logs.filter(log => {
                if (logFilter !== 'all' && log.type !== logFilter) return false;
                if (logSearch && !log.message.toLowerCase().includes(logSearch.toLowerCase())) return false;
                return true;
            });

            const startSimulation = async () => {
                setStage('analyzing'); setLogs([]); setShowTestResults(false); setExpandedStep(null);
                const docName = MOCK_DOCS.find(d => d.id === selectedDoc)?.name || '未知文档';
                addLog('info', `启动新测试任务 | 分支: ${selectedBranch}`);
                addLog('info', `加载需求文档: ${docName}`);
                await new Promise(r => setTimeout(r, 1500));
                addLog('ai', '正在分析代码变更影响范围...');
                addLog('ai', '检测到核心业务逻辑变更: ShippingCalculator.java');
                addLog('ai', '影响模块: OrderService, CheckoutController');
                setStage('generating');
                await new Promise(r => setTimeout(r, 1500));
                addLog('ai', '解析 PRD 文档中的验证规则...');
                addLog('ai', '发现逻辑偏差！Level 2 用户运费规则未实现');
                addLog('success', '已生成 5 个测试用例');
                setStage('executing');
                await new Promise(r => setTimeout(r, 2000));
                addLog('info', '正在 Docker 沙箱中执行测试...');
                addLog('info', '运行测试: test_level1_shipping_fixed_fee... PASSED');
                addLog('error', '测试失败: test_level2_shipping_discount');
                addLog('error', '断言失败: 期望值 7.50, 实际返回 15.00');
                setStage('failure');
                await new Promise(r => setTimeout(r, 1000));
                setStage('healing');
                addLog('ai', '启动根因分析 (RCA)...');
                addLog('ai', '根因: 代码缺少 Level 2 用户逻辑分支');
                addLog('ai', '正在生成修复补丁...');
                await new Promise(r => setTimeout(r, 2500));
                addLog('info', '应用补丁并重新运行验证测试...');
                addLog('success', '所有测试用例通过 (5/5)');
                setStage('success');
                setShowTestResults(true);
                addLog('gitlab', `测试通过。正在向 GitLab MR 提交修复补丁...`);
                addLog('success', '任务完成: 代码已根据 PRD 修复并验证。');
            };

            return (
                <div className="flex flex-col h-screen bg-black overflow-hidden">
                    <Navbar active="workspace" />
                    <div className="flex flex-col flex-1 overflow-hidden fade-in">
                        {/* Status Bar */}
                        <div className="h-12 bg-[#0F0F0F] border-b border-white/5 flex items-center px-6 justify-between text-sm shrink-0">
                            {stage === 'idle' ? (
                                <div className="text-white/40 text-xs font-mono flex items-center gap-2">
                                    <span className="w-2 h-2 rounded-full bg-white/20"></span>
                                    READY // WAITING FOR INPUT
                                </div>
                            ) : (
                                <div className="flex items-center gap-6">
                                    <div className="flex items-center gap-2 text-white/60 bg-white/5 px-3 py-1.5 rounded-lg border border-white/5">
                                        <Lucide name="GitPullRequest" size={14} className="text-orange-500" />
                                        <span className="font-mono text-white/90 font-bold">{selectedBranch}</span>
                                    </div>
                                    <div className="flex items-center gap-2 text-white/60 bg-white/5 px-3 py-1.5 rounded-lg border border-white/5">
                                        <Lucide name="FileText" size={14} className="text-blue-400" />
                                        <span className="font-mono text-white/90 truncate max-w-[300px]">{MOCK_DOCS.find(d => d.id === selectedDoc)?.name}</span>
                                    </div>
                                </div>
                            )}
                            {stage !== 'idle' && (
                                <div className="flex items-center gap-2">
                                    <span className={`px-3 py-1 rounded-full text-xs font-bold ${
                                        stage === 'success' ? 'bg-emerald-500/10 text-emerald-400 border border-emerald-500/20' :
                                        stage === 'failure' ? 'bg-rose-500/10 text-rose-400 border border-rose-500/20' :
                                        'bg-indigo-500/10 text-indigo-400 border border-indigo-500/20'
                                    }`}>
                                        {stage === 'success' ? '已完成' : stage === 'failure' ? '检测到问题' : '处理中...'}
                                    </span>
                                </div>
                            )}
                        </div>

                        <PipelineSteps currentStage={stage} expandedStep={expandedStep} onStepClick={setExpandedStep} />

                        {/* Main Content Area */}
                        <div className="flex-1 flex overflow-hidden">
                            {/* Left Pane: Code/Config */}
                            <div className="flex-1 border-r border-white/5 flex flex-col relative bg-[#050505]">
                                {stage === 'idle' ? (
                                    <div className="flex-1 overflow-y-auto scrollbar-thin">
                                        <div className="flex flex-col items-center justify-center min-h-full p-8">
                                            <div className="w-full max-w-xl space-y-10">
                                                <div className="text-center space-y-4">
                                                    <div className="w-20 h-20 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-3xl flex items-center justify-center mx-auto shadow-2xl shadow-indigo-500/30 mb-8 ring-1 ring-white/10">
                                                        <Lucide name="Sparkles" size={40} className="text-white" />
                                                    </div>
                                                    <h2 className="text-4xl font-bold text-white tracking-tight">新建智能测试任务</h2>
                                                    <p className="text-white/40 text-lg">AI 将自动校验代码与需求文档的一致性，生成测试用例并修复缺陷。</p>
                                                </div>
                                                <div className="bg-[#0F0F0F] border border-white/10 rounded-3xl p-8 space-y-8 backdrop-blur-sm shadow-xl">
                                                    <div className="space-y-3">
                                                        <label className="text-sm font-bold text-white/70 flex items-center gap-2 uppercase tracking-wider">
                                                            <Lucide name="GitMerge" size={16} /> 选择功能分支
                                                        </label>
                                                        <div className="relative group">
                                                            <select value={selectedBranch} onChange={(e) => setSelectedBranch(e.target.value)} className="w-full bg-black border border-white/10 rounded-xl px-5 py-4 text-white appearance-none focus:outline-none focus:border-indigo-500/50 transition-colors font-mono cursor-pointer group-hover:bg-white/5">
                                                                {MOCK_BRANCHES.map(b => (<option key={b} value={b}>{b}</option>))}
                                                            </select>
                                                            <div className="absolute right-5 top-4 text-white/30 pointer-events-none">
                                                                <Lucide name="ChevronRight" size={20} className="rotate-90" />
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div className="space-y-3">
                                                        <label className="text-sm font-bold text-white/70 flex items-center gap-2 uppercase tracking-wider">
                                                            <Lucide name="FileText" size={16} /> 关联需求文档
                                                        </label>
                                                        <div className="relative group">
                                                            <select value={selectedDoc} onChange={(e) => setSelectedDoc(e.target.value)} className="w-full bg-black border border-white/10 rounded-xl px-5 py-4 text-white appearance-none focus:outline-none focus:border-indigo-500/50 transition-colors cursor-pointer group-hover:bg-white/5">
                                                                {MOCK_DOCS.map(d => (<option key={d.id} value={d.id}>{d.name}</option>))}
                                                            </select>
                                                            <div className="absolute right-5 top-4 text-white/30 pointer-events-none">
                                                                <Lucide name="ChevronRight" size={20} className="rotate-90" />
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <button onClick={startSimulation} className="w-full py-5 bg-indigo-600 hover:bg-indigo-500 text-white font-bold text-lg rounded-xl shadow-lg shadow-indigo-600/20 flex items-center justify-center gap-3 transition-all hover:scale-[1.02] active:scale-[0.98]">
                                                        <Lucide name="Play" size={24} fill="currentColor" /> 保存配置并开始分析
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="flex-1 flex flex-col overflow-hidden">
                                        {/* Code Toolbar */}
                                        <div className="h-12 bg-[#0A0A0A] border-b border-white/5 flex items-center px-6 justify-between shrink-0">
                                            <div className="flex items-center gap-3">
                                                <span className="flex items-center text-xs font-mono text-white/80 bg-white/5 px-2.5 py-1.5 rounded border border-white/10 shadow-sm">
                                                    <Lucide name="FileCode" size={12} className="mr-2 text-indigo-400" />
                                                    ShippingCalculator.java
                                                </span>
                                                {(stage === 'healing' || stage === 'success') && (
                                                    <span className="text-xs text-emerald-400 flex items-center gap-1 bg-emerald-500/10 px-2 py-1 rounded">
                                                        <Lucide name="Zap" size={12} /> AI 修复已应用
                                                    </span>
                                                )}
                                            </div>
                                            <div className="flex items-center gap-2">
                                                {/* View Mode Toggle */}
                                                <div className="flex items-center bg-white/5 rounded-lg p-0.5 border border-white/5">
                                                    <button
                                                        onClick={() => setViewMode('split')}
                                                        className={`px-3 py-1.5 rounded-md text-xs font-medium transition-all flex items-center gap-1.5 ${viewMode === 'split' ? 'bg-white/10 text-white' : 'text-white/40 hover:text-white/80'}`}
                                                    >
                                                        <Lucide name="SplitSquareHorizontal" size={12} /> 分栏
                                                    </button>
                                                    <button
                                                        onClick={() => setViewMode('unified')}
                                                        className={`px-3 py-1.5 rounded-md text-xs font-medium transition-all flex items-center gap-1.5 ${viewMode === 'unified' ? 'bg-white/10 text-white' : 'text-white/40 hover:text-white/80'}`}
                                                    >
                                                        <Lucide name="Layers" size={12} /> 统一
                                                    </button>
                                                </div>
                                                <button className="p-2 hover:bg-white/5 rounded-lg text-white/40 hover:text-white transition-colors" title="复制代码">
                                                    <Lucide name="Copy" size={14} />
                                                </button>
                                                <button className="p-2 hover:bg-white/5 rounded-lg text-white/40 hover:text-white transition-colors" title="下载补丁">
                                                    <Lucide name="Download" size={14} />
                                                </button>
                                            </div>
                                        </div>

                                        {/* Diff View */}
                                        <div className="flex-1 overflow-hidden bg-[#050505]">
                                            <DiffView
                                                before={CODE_BEFORE}
                                                after={CODE_AFTER}
                                                viewMode={viewMode}
                                            />
                                        </div>

                                        {/* Test Results Panel */}
                                        <TestResultsPanel testCases={TEST_CASES} isVisible={showTestResults} />
                                    </div>
                                )}
                            </div>

                            {/* Right Pane: Logs */}
                            <div className="w-[480px] bg-[#020202] flex flex-col border-l border-white/5 shrink-0 z-20 shadow-2xl">
                                {/* Terminal Header */}
                                <div className="h-12 border-b border-white/5 flex items-center px-5 bg-[#0A0A0A] justify-between shrink-0">
                                    <span className="text-xs font-bold text-white/50 flex items-center gap-2 uppercase tracking-widest">
                                        <Lucide name="Terminal" size={14} /> 智能终端
                                    </span>
                                    <div className="flex gap-1.5">
                                        {['bg-red-500/40', 'bg-yellow-500/40', 'bg-green-500/40'].map(c => (
                                            <div key={c} className={`w-2.5 h-2.5 rounded-full ${c}`} />
                                        ))}
                                    </div>
                                </div>

                                {/* Log Filters */}
                                {logs.length > 0 && (
                                    <div className="px-5 py-3 border-b border-white/5 bg-[#080808] space-y-3">
                                        {/* Search */}
                                        <div className="relative">
                                            <Lucide name="Search" size={14} className="absolute left-3 top-2.5 text-white/30" />
                                            <input
                                                type="text"
                                                placeholder="搜索日志..."
                                                value={logSearch}
                                                onChange={(e) => setLogSearch(e.target.value)}
                                                className="w-full bg-black/50 border border-white/10 rounded-lg pl-9 pr-4 py-2 text-xs text-white placeholder-white/30 focus:outline-none focus:border-indigo-500/50"
                                            />
                                        </div>
                                        {/* Filter Tabs */}
                                        <div className="flex items-center gap-1.5">
                                            {[
                                                { id: 'all', label: '全部', count: logs.length },
                                                { id: 'ai', label: 'AI', count: logs.filter(l => l.type === 'ai').length },
                                                { id: 'error', label: '错误', count: logs.filter(l => l.type === 'error').length },
                                                { id: 'success', label: '成功', count: logs.filter(l => l.type === 'success').length },
                                            ].map(filter => (
                                                <button
                                                    key={filter.id}
                                                    onClick={() => setLogFilter(filter.id)}
                                                    className={`px-2.5 py-1 rounded text-[10px] font-medium transition-all flex items-center gap-1 ${
                                                        logFilter === filter.id
                                                            ? 'bg-indigo-500/20 text-indigo-400 border border-indigo-500/30'
                                                            : 'text-white/40 hover:text-white/80 border border-transparent hover:bg-white/5'
                                                    }`}
                                                >
                                                    {filter.label}
                                                    <span className="text-white/30">({filter.count})</span>
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {/* Log Content */}
                                <div className="flex-1 p-5 overflow-y-auto space-y-4 font-mono text-xs scrollbar-thin" ref={scrollRef}>
                                    {logs.length === 0 && (
                                        <div className="h-full flex flex-col items-center justify-center text-white/10 gap-6 select-none">
                                            <Lucide name="Sparkles" size={64} className="opacity-20" />
                                            <p className="text-center">TERMINAL READY<br />WAITING FOR COMMAND...</p>
                                        </div>
                                    )}
                                    {filteredLogs.map((log) => (
                                        <div key={log.id} className="fade-in group">
                                            <div className="flex gap-4 text-white/90">
                                                <span className="text-white/20 shrink-0 select-none w-16 text-right font-light group-hover:text-white/40 transition-colors">{log.timestamp.split(' ')[0]}</span>
                                                <div className="flex-1 break-words">
                                                    {log.type === 'gitlab' && <span className="text-orange-500 font-bold mr-2 text-[10px] bg-orange-500/10 px-1.5 py-0.5 rounded">GIT</span>}
                                                    {log.type === 'ai' && <span className="text-indigo-400 font-bold mr-2 text-[10px] bg-indigo-500/10 px-1.5 py-0.5 rounded">AI</span>}
                                                    {log.type === 'error' && <span className="text-rose-500 font-bold mr-2 text-[10px] bg-rose-500/10 px-1.5 py-0.5 rounded">ERR</span>}
                                                    {log.type === 'success' && <span className="text-emerald-500 font-bold mr-2 text-[10px] bg-emerald-500/10 px-1.5 py-0.5 rounded">OK</span>}
                                                    {log.type === 'info' && <span className="text-blue-400 font-bold mr-2 text-[10px] bg-blue-500/10 px-1.5 py-0.5 rounded">SYS</span>}
                                                    <span className={`leading-relaxed ${
                                                        log.type === 'error' ? 'text-rose-400' :
                                                        log.type === 'ai' ? 'text-indigo-200' :
                                                        log.type === 'gitlab' ? 'text-orange-200' :
                                                        log.type === 'success' ? 'text-emerald-400' :
                                                        'text-white/60'
                                                    }`}>{log.message}</span>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>

                                {/* Terminal Footer */}
                                <div className="p-5 border-t border-white/5 bg-[#050505] shrink-0">
                                    {stage === 'idle' ? (
                                        <div className="text-center text-xs text-white/20 font-mono py-2">System Idle</div>
                                    ) : stage === 'success' ? (
                                        <div className="flex gap-3 slide-up">
                                            <button onClick={() => { setStage('idle'); setShowTestResults(false); }} className="flex-1 py-3 rounded-xl font-bold text-xs flex items-center justify-center gap-2 transition-all bg-white/5 text-white/60 hover:bg-white/10 hover:text-white">
                                                <Lucide name="FilePlus" size={14} /> 新建任务
                                            </button>
                                            <button onClick={startSimulation} className="flex-1 py-3 rounded-xl font-bold text-xs flex items-center justify-center gap-2 transition-all bg-emerald-600 hover:bg-emerald-500 text-white shadow-lg shadow-emerald-900/20">
                                                <Lucide name="RotateCcw" size={14} /> 再次执行
                                            </button>
                                        </div>
                                    ) : (
                                        <div className="w-full py-3 rounded-lg border border-indigo-500/20 bg-indigo-500/5 text-indigo-300 text-xs font-bold flex items-center justify-center gap-2 cursor-not-allowed">
                                            <Lucide name="Loader2" size={14} className="animate-spin" /> PROCESSING...
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<WorkspaceView />);
    </script>
</body>

</html>
